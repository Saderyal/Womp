export default class x extends HTMLElement{constructor(){super();this._cmxsComponent=!0;this.rendering=!1}static{this.componentName=""}static{this.options={}}static{this.initialProps={}}static{this.css=""}static{this.__specificComponentCssGenerated=null}connectedCallback(){this.initElement()}disconnectedCallback(){this.onDisconnected()}attributeChangedCallback(e,s,n){this.isConnected&&this.onAttributeChanged(e,s,n)}initElement(){if(this.rendering=!0,this.ROOT=this,this.styles=this.getGeneratedStyles(),this.state||(this.state={}),!this.props){this.props={...this.constructor.initialProps};for(const r of this.attributes){const a=r.value,i=r.name;a==="true"?this.props[i]=!0:a==="false"?this.props[i]=!1:this.props[i]=a}}this.props.children||(this.props.children=this.deepCloneNodes(this.childNodes)),{...{isolated:!1},...this.constructor.options}.isolated&&(this.innerHTML="",this.ROOT=this.attachShadow({mode:"open"})),this.onInit();const n=this.getNodesToRender();this.ROOT.replaceChildren(...n),this.rendering=!1,this.onFirstRender(),this.onRendered()}getGeneratedStyles(){const e=this.constructor;let s=!0;const n=e.componentName;if(!e.__specificComponentCssGenerated){s=!1,e.__specificComponentCssGenerated={};const a=e.css.trim(),i=[];[...a.matchAll(/.*?}([\s\S]*?){/gm)].forEach(h=>{const u=h[1].trim();u.includes(".")||i.push(u)}),i.forEach(h=>{console.warn(`The CSS selector "${h} {...}" in the component "${n}" is not enough specific: include at least one class.
This can lead to some issues and chances to override global or other components styles.`)});const l=new Set;[...a.matchAll(/\.(.*?)[\s|{]/gm)].forEach(h=>{const u=h[1];l.add(u)});let c=a;l.forEach(h=>{const u=`${n}__${h}`;c=c.replaceAll(h,u),e.__specificComponentCssGenerated[h]=u}),e.__specificComponentCssGenerated.__generatedCSS=c}const r=this.ROOT.getRootNode();if(!s&&r.body&&!e.options.isolated){const a=e.__specificComponentCssGenerated.__generatedCSS,i=document.createElement("style");i.classList.add(`${n}__styles`),i.innerHTML=`		${n}{display: block;} ${a}`,document.body.appendChild(i)}return e.__specificComponentCssGenerated}getNodesToRender(){const e=this.render();let s=e;(typeof e=="string"||e instanceof HTMLElement)&&(s=html`${e}`);const n=this.handleHtml(s);let a=this.handleSelfClosingTagsAndMark(n);const i=this.constructor;if(i.options.isolated||!this.getRootNode().body){const o=i.componentName,t=i.__specificComponentCssGenerated.__generatedCSS;a+=`<style class="${o}__styles">${t}</style>`}const c=document.createElement("div");c.innerHTML=a;const h=o=>{let t=s.values;for(const d of o)t.__cmxs&&(t=t.values),t=t[parseInt(d)];return t};c.querySelectorAll("[cmxs-component-html-elements]").forEach(o=>{const t=o.getAttribute("cmxs-component-html-elements").split("-"),d=h(t);d instanceof NodeList||d instanceof HTMLCollection?o.replaceWith(...this.deepCloneNodes(d)):o.replaceWith(d.cloneNode(!0))});const u=c.querySelectorAll("[cmxs-custom-component]");for(let o=u.length-1;o>=0;o--){const t=u[o];t.removeAttribute("cmxs-custom-component"),t._cmxsComponent=!0;const d=t.constructor;t.props=structuredClone(d.initialProps||{}),t.props.children=this.deepCloneNodes(t.childNodes);for(const f of t.attributes){const p=f.value,y=p.match(/__{{(.*?)}}__/);if(y){const m=y[1].split("-"),v=h(m);t.props[f.name]=v,typeof v=="string"||typeof v=="number"||typeof v=="boolean"?t.setAttribute(f.name,v.toString()):t.removeAttribute(f.name)}else p===""?(t.setAttribute(f.name,"true"),t.props[f.name]=!0):t.props[f.name]=p}}const g=[],C=o=>{for(const t of o.childNodes)t.nodeName.includes("-")?g.push(t):C(t)};C(c);for(const o of g)o.innerHTML="";return c.querySelectorAll("[cmxs-component-with-event]").forEach(o=>{o.removeAttribute("cmxs-component-with-event"),o.events={};for(const t of o.attributes)if(t.name.startsWith("@")){const d=t.value.match(/__{{(.*?)}}__/)[1].split("-"),f=h(d),p=t.name.substring(1);o.addEventListener(p,f),o.attributes.removeNamedItem(t.name),o.events[p]=f}}),c.childNodes}handleHtml(e,s=""){const{parts:n,values:r}=e;let a="";for(let i=0;i<n.length;i++){const l=n[i],c=r[i];if(a+=l,c!==void 0)if(!l.endsWith("="))a+=this.handleHtmlValue(c,s,i.toString());else{const h=s===""?i.toString():`${s}-${i}`,u=l.split(" "),g=u[u.length-1];if(g==="style="&&typeof c=="object"){let C="";const o=Object.keys(c);for(const t of o){let d=c[t],f=t.replace(/[A-Z]/g,p=>"-"+p.toLowerCase());typeof d=="number"&&(d=`${d}px`),C+=`${f}:${d};`}a+=`"${C}"`}else{const C=g.trim().startsWith("@");a+=`"__{{${h}}}__"`,C&&(a+=" cmxs-component-with-event")}}}return a}handleHtmlValue(e,s,n){let r="";const a=s===""?n.toString():`${s}-${n}`;if(e===!1||e===null)return r;if(e.__cmxs)r+=this.handleHtml(e,a);else if(Array.isArray(e))for(let i=0;i<e.length;i++){const l=e[i];r+=this.handleHtmlValue(l,a,i.toString())+`
`}else e instanceof HTMLElement||e instanceof NodeList||e instanceof HTMLCollection?r+=`<div cmxs-component-html-elements="${a}"></div>`:e.prototype instanceof x?r+=e.componentName:r+=e;return r}handleSelfClosingTagsAndMark(e){let s=e;const n=[...s.matchAll(/<([a-z]*-[a-z|-]*)(.*?)>/gs)];let r=0;const a="cmxs-custom-component";return n.forEach(i=>{const[l,c,h]=i,u=s.slice(0,i.index+r),g=s.slice(i.index+l.length+r);if(l.endsWith("/>")){const C=`<${c}${h} ${a}></${c}>`;s=`${u}${C}${g}`,r+=c.length+2+a.length+1}else{const C=`<${c}${h} ${a}>`;s=`${u}${C}${g}`,r+=a.length+1}}),s}deepCloneNodes(e){const s=document.createElement("div");return[...e].forEach(n=>{const r=n.cloneNode(!1);if(n._cmxsComponent&&(r.props=n.props,r.state=n.state,r._cmxsComponent=!0),s.appendChild(r),r.replaceChildren){const a=this.deepCloneNodes(n.childNodes);r.replaceChildren(...a)}}),s.childNodes}setState(e){let s=e;typeof e=="function"&&(s=e(this.state,this.props));let n=!1;for(const r in s){const a=this.state[r],i=s[r];a===void 0&&console.warn(`The property "${r}" is a new state property. Avoid setting new state properties.
Instead, initialize the state by setting that property to "null".`),a!==i&&(typeof a=="object"&&typeof i=="object"?n=!this.deepCompareObjects(a,i):n=!0,n&&(this.state[r]=i))}n&&!this.rendering&&(this.rendering=!0,Promise.resolve().then(()=>{const r=this.getNodesToRender();this.updateComponent(r),this.rendering=!1,this.onRendered()}))}updateComponent(e,s=!0){const n=this.ROOT.childNodes;this.recursivelyCompare(this,n,e,s)}recursivelyCompare(e,s,n,r){const a=s.length-n.length;for(let i=0;i<n.length;i++){const l=s[i],c=n[i];if(!l){e.appendChild(c);continue}if(l.events||c.events){const o=l,t=c;o.events||(o.events={});const d=Object.keys(o.events),f=Object.keys(t.events);for(const p of d){const y=o.events[p];t.events[p]||(delete o.events[p],l.removeEventListener(p,y))}for(const p of f){const y=o.events[p],m=t.events[p];y?y!==m&&(o.events[p]=m,l.removeEventListener(p,y),l.addEventListener(p,m)):(o.events[p]=m,l.addEventListener(p,m))}}if(c._cmxsComponent&&c.nodeName===l.nodeName){const o=l,t=c;if(!t.props){const m=t.constructor;t.props=structuredClone(m.initialProps||{}),t.props.children=t.childNodes;for(const v of t.attributes){const b=v.value;b===""?(t.setAttribute(v.name,"true"),t.props[v.name]=!0):t.props[v.name]=b}}if(!this.deepCompareObjects(o.props,t.props)){for(const m of o.attributes)t.hasAttribute(m.name)||o.removeAttribute(m.name);for(const m of t.attributes)o.getAttribute(m.name)!==m.value&&o.setAttribute(m.name,m.value);o.requestReload(t);continue}if(!r)continue;let f=!1;const p=t.props?.children??[],y=o.props?.children;if(p.length!==y.length){o.requestReload(t);continue}for(let m=0;m<y.length;m++)if(!p[m].isEqualNode(y[m])){f=!0;break}f&&o.requestReload(t);continue}const u=l.cloneNode(!1),g=c.cloneNode(!1);if(u.isEqualNode(g))this.recursivelyCompare(l,l.childNodes,c.childNodes,r);else{const o=c.cloneNode(!0),t=c.events,d=Object.keys(t||{});for(const f of d)o.addEventListener(f,t[f]);l.replaceWith(o)}}if(a>0){let i=0;for(;i<a;)e.childNodes[n.length].remove(),i++}}deepCompareObjects(e,s){if(e===s)return!0;if(!(e instanceof Object)||!(s instanceof Object)||e.constructor!==s.constructor)return!1;for(const n in e)if(n!=="children"&&e.hasOwnProperty(n)){if(!s.hasOwnProperty(n))return!1;if(e[n]!==s[n]&&(typeof e[n]!="object"||!this.deepCompareObjects(e[n],s[n])))return!1}for(const n in s)if(n!=="children"&&s.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}requestReload(e=null){if(e){const r=e.props;this.props={...this.props,...r}}const s=this.getNodesToRender(),n=!!e;this.updateComponent(s,n),this.onRendered()}getDepenciesProps(e){const s=[],n=e.componentName;return this.querySelectorAll(n).forEach(r=>s.push(r.props)),s}onInit(){}onDisconnected(){}onFirstRender(){}onRendered(){}onAttributeChanged(e,s,n){}render(){throw new Error(`CmxsComponent: Unimplemented render method in "${this.constructor.name}"`)}}export function html(_,...N){return{parts:_,values:N,__cmxs:!0}}function S(){const _={};return N=>{customElements.define(N.componentName,N)}}export const defineCmxsComponent=S();
